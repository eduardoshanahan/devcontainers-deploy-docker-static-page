---
# =============================================================================
# TRAEFIK INTEGRATION TESTING PLAYBOOK
# =============================================================================
# This playbook tests if Traefik is properly serving the static web page
# and provides comprehensive diagnostics for the reverse proxy setup.
# =============================================================================

- name: Test Traefik Integration and External Access
  hosts: vps
  become: false
  gather_facts: true

  tasks:
    - name: Display test configuration
      ansible.builtin.debug:
        msg: |
          ==============================================================================
          TRAEFIK INTEGRATION TESTING
          ==============================================================================
          Target Domain: {{ vault_traefik_domain }}
          Container Name: {{ static_web_container_name }}
          Expected Port: {{ static_web_port }}
          ==============================================================================

    - name: Verify static web container is running
      community.docker.docker_container_info:
        name: "{{ static_web_container_name }}"
      register: container_status
      failed_when:
        - not container_status.container
        - container_status.container.State.Status != "running"

    - name: Check Traefik container status
      community.docker.docker_container_info:
        name: traefik
      register: traefik_status
      ignore_errors: true

    - name: Check all containers in Traefik network
      community.docker.docker_container_info:
        name: "{{ item }}"
      loop:
        - traefik
        - "{{ static_web_container_name }}"
      register: all_containers

    - name: Display container network status
      ansible.builtin.debug:
        msg: |
          ==============================================================================
          CONTAINER STATUS CHECK
          ==============================================================================
          {% for container in all_containers.results %}
          Container: {{ container.container.Name if container.container else 'Not found' }}
          Status: {{ container.container.State.Status if container.container else 'Not running' }}
          Networks: {{ container.container.NetworkSettings.Networks.keys() | list if container.container else 'N/A' }}
          {% endfor %}
          ==============================================================================

    - name: Test internal container access (localhost)
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ static_web_port }}"
        method: GET
        timeout: 10
      register: internal_test
      failed_when: internal_test.status != 200

    - name: Test Traefik internal access
      ansible.builtin.uri:
        url: "http://127.0.0.1:80"
        method: GET
        timeout: 10
      register: traefik_internal_test
      ignore_errors: true

    - name: Test external domain access via Traefik
      ansible.builtin.uri:
        url: "http://{{ vault_traefik_domain }}"
        method: GET
        timeout: 30
        status_code: [200, 301, 302, 404, 502, 503]
      register: external_test
      ignore_errors: true

    - name: Test with Host header to simulate domain access
      ansible.builtin.uri:
        url: "http://127.0.0.1:80"
        method: GET
        headers:
          Host: "{{ vault_traefik_domain }}"
        timeout: 10
      register: host_header_test
      ignore_errors: true

    - name: Display comprehensive test results
      ansible.builtin.debug:
        msg: |
          ==============================================================================
          TRAEFIK INTEGRATION TEST RESULTS
          ==============================================================================
          Internal Container Test: ‚úÖ HTTP {{ internal_test.status }}
          Traefik Internal Test: ‚úÖ HTTP {{ traefik_internal_test.status if traefik_internal_test.status is defined else 'N/A' }}
          External Domain Test: ‚úÖ HTTP {{ external_test.status if external_test.status is defined else 'N/A' }}
          Host Header Test: ‚úÖ HTTP {{ host_header_test.status if host_header_test.status is defined else 'N/A' }}
          ==============================================================================
          {% if external_test.status == 200 %}
          üéâ SUCCESS: Traefik is serving your static web page!
          {% else %}
          ‚ö†Ô∏è  WARNING: External test returned {{ external_test.status }}
          {% endif %}
          ==============================================================================

    - name: Show Traefik logs for debugging
      ansible.builtin.shell: |
        docker logs traefik --tail=20
      register: traefik_logs
      changed_when: false
      ignore_errors: true

    - name: Show container logs for debugging
      ansible.builtin.shell: |
        docker logs {{ static_web_container_name }} --tail=20
      register: container_logs
      changed_when: false
      ignore_errors: true

    - name: Display logs
      ansible.builtin.debug:
        msg: |
          ==============================================================================
          TRAEFIK LOGS (Last 20 lines)
          ==============================================================================
          {{ traefik_logs.stdout if traefik_logs.stdout else 'No logs available' }}
          ==============================================================================
          CONTAINER LOGS (Last 20 lines)
          ==============================================================================
          {{ container_logs.stdout if container_logs.stdout else 'No logs available' }}
          ==============================================================================
